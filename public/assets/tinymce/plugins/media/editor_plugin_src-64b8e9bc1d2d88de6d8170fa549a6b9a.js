/**
 * editor_plugin_src.js
 *
 * Copyright 2009, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://tinymce.moxiecode.com/license
 * Contributing: http://tinymce.moxiecode.com/contributing
 */
(function(){function u(e){return typeof e=="string"?e.replace(/[^0-9%]/g,""):e}function a(e){var t,n,r;if(e&&!e.splice){n=[];for(r=0;!0;r++){if(!e[r])break;n[r]=e[r]}return n}return e}var e=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),t=tinymce.makeMap(e.join(",")),n=tinymce.html.Node,r,i,s=tinymce.util.JSON,o;r=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]],tinymce.create("tinymce.plugins.MediaPlugin",{init:function(t,n){function h(e){return e&&e.nodeName==="IMG"&&t.dom.hasClass(e,"mceItemMedia")}var o=this,u={},a,f,l,c;o.editor=t,o.url=n,i="";for(a=0;a<r.length;a++){c=r[a][0],l={name:c,clsids:tinymce.explode(r[a][1]||""),mimes:tinymce.explode(r[a][2]||""),codebase:r[a][3]};for(f=0;f<l.clsids.length;f++)u["clsid:"+l.clsids[f]]=l;for(f=0;f<l.mimes.length;f++)u[l.mimes[f]]=l;u["mceItem"+c]=l,u[c.toLowerCase()]=l,i+=(i?"|":"")+c}tinymce.each(t.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(e){var t,n,r;e=e.split(/=/),n=tinymce.explode(e[1].toLowerCase());for(t=0;t<n.length;t++)r=u[e[0].toLowerCase()],r&&(u[n[t]]=r)}),i=new RegExp("write("+i+")\\(([^)]+)\\)"),o.lookup=u,t.onPreInit.add(function(){t.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),t.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(e){var t=e.length;while(t--)o.objectToImg(e[t])}),t.serializer.addNodeFilter("img",function(e,t,n){var r=e.length,i;while(r--)i=e[r],(i.attr("class")||"").indexOf("mceItemMedia")!==-1&&o.imgToObject(i,n)})}),t.onInit.add(function(){t.theme&&t.theme.onResolveName&&t.theme.onResolveName.add(function(e,n){n.name==="img"&&t.dom.hasClass(n.node,"mceItemMedia")&&(n.name="media")}),t&&t.plugins.contextmenu&&t.plugins.contextmenu.onContextMenu.add(function(e,t,n){n.nodeName==="IMG"&&n.className.indexOf("mceItemMedia")!==-1&&t.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),t.addCommand("mceMedia",function(){var r,i;i=t.selection.getNode(),h(i)&&(r=t.dom.getAttrib(i,"data-mce-json"),r&&(r=s.parse(r),tinymce.each(e,function(e){var n=t.dom.getAttrib(i,e);n&&(r[e]=n)}),r.type=o.getType(i.className).name.toLowerCase())),r||(r={type:"flash",video:{sources:[]},params:{}}),t.windowManager.open({file:n+"/media.htm",width:430+parseInt(t.getLang("media.delta_width",0)),height:500+parseInt(t.getLang("media.delta_height",0)),inline:1},{plugin_url:n,data:r})}),t.addButton("media",{title:"media.desc",cmd:"mceMedia"}),t.onNodeChange.add(function(e,t,n){t.setActive("media",h(n))})},convertUrl:function(e,t){var n=this,r=n.editor,i=r.settings,s=i.url_converter,o=i.url_converter_scope||n;return e?t?r.documentBaseURI.toAbsolute(e):s.call(o,e,"src","object"):e},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(e,t){var n=this,r=n.editor,i=r.documentBaseURI,o,f,l,c;e.params.src=n.convertUrl(e.params.src,t),f=e.video.attrs,f&&(f.src=n.convertUrl(f.src,t)),f&&(f.poster=n.convertUrl(f.poster,t)),o=a(e.video.sources);if(o)for(c=0;c<o.length;c++)o[c].src=n.convertUrl(o[c].src,t);return l=n.editor.dom.create("img",{id:e.id,style:e.style,align:e.align,hspace:e.hspace,vspace:e.vspace,src:n.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+n.getType(e.type).name,"data-mce-json":s.serialize(e,"'")}),l.width=e.width=u(e.width||(e.type=="audio"?"300":"320")),l.height=e.height=u(e.height||(e.type=="audio"?"32":"240")),l},dataToHtml:function(e,t){return this.editor.serializer.serialize(this.dataToImg(e,t),{forced_root_block:"",force_absolute:t})},htmlToData:function(t){var n,r,i;return i={type:"flash",video:{sources:[]},params:{}},n=this.editor.parser.parse(t),r=n.getAll("img")[0],r&&(i=s.parse(r.attr("data-mce-json")),i.type=this.getType(r.attr("class")).name.toLowerCase(),tinymce.each(e,function(e){var t=r.attr(e);t&&(i[e]=t)})),i},getType:function(e){var t,n,r;n=tinymce.explode(e," ");for(t=0;t<n.length;t++){r=this.lookup[n[t]];if(r)return r}},imgToObject:function(t,r){function L(e,t){var n,r,s,u,a;a=o.getParam("flash_video_player_url",i.convertUrl(i.url+"/moxieplayer.swf")),a&&(n=o.documentBaseURI,v.params.src=a,o.getParam("flash_video_player_absvideourl",!0)&&(e=n.toAbsolute(e||"",!0),t=n.toAbsolute(t||"",!0)),s="",r=o.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(r,function(n,r){n=n.replace(/\$url/,e||""),n=n.replace(/\$poster/,t||""),n.length>0&&(s+=(s?"&":"")+r+"="+escape(n))}),s.length&&(v.params.flashvars=s),u=o.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(u,function(e,t){v.params[t]=""+e}))}var i=this,o=i.editor,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k;v=t.attr("data-mce-json");if(!v)return;v=s.parse(v),w=this.getType(t.attr("class")),C=t.attr("data-mce-style"),C||(C=t.attr("style"),C&&(C=o.dom.serializeStyle(o.dom.parseStyle(C,"img")))),v.width=t.attr("width")||v.width,v.height=t.attr("height")||v.height;if(w.name==="Iframe"){T=new n("iframe",1),tinymce.each(e,function(e){var n=t.attr(e);e=="class"&&n&&(n=n.replace(/mceItem.+ ?/g,"")),n&&n.length>0&&T.attr(e,n)});for(p in v.params)T.attr(p,v.params[p]);T.attr({style:C,src:v.params.src}),t.replace(T);return}if(this.editor.settings.media_use_script){T=(new n("script",1)).attr("type","text/javascript"),d=new n("#text",3),d.value="write"+w.name+"("+s.serialize(tinymce.extend(v.params,{width:t.attr("width"),height:t.attr("height")}))+");",T.append(d),t.replace(T);return}if(w.name==="Video"&&v.video.sources[0]){f=(new n("video",1)).attr(tinymce.extend({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:C},v.video.attrs)),v.video.attrs&&(N=v.video.attrs.poster),g=v.video.sources=a(v.video.sources);for(E=0;E<g.length;E++)/\.mp4$/.test(g[E].src)&&(x=g[E].src);g[0].type||(f.attr("src",g[0].src),g.splice(0,1));for(E=0;E<g.length;E++)m=(new n("source",1)).attr(g[E]),m.shortEnded=!0,f.append(m);x?(L(x,N),w=i.getType("flash")):v.params.src=""}if(w.name==="Audio"&&v.video.sources[0]){k=(new n("audio",1)).attr(tinymce.extend({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:C},v.video.attrs)),v.video.attrs&&(N=v.video.attrs.poster),g=v.video.sources=a(v.video.sources),g[0].type||(k.attr("src",g[0].src),g.splice(0,1));for(E=0;E<g.length;E++)m=(new n("source",1)).attr(g[E]),m.shortEnded=!0,k.append(m);v.params.src=""}if(w.name==="EmbeddedAudio"){c=new n("embed",1),c.shortEnded=!0,c.attr({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:C,type:t.attr("type")});for(p in v.params)c.attr(p,v.params[p]);tinymce.each(e,function(e){v[e]&&e!="type"&&c.attr(e,v[e])}),v.params.src=""}if(v.params.src){/\.flv$/i.test(v.params.src)&&L(v.params.src,""),r&&r.force_absolute&&(v.params.src=o.documentBaseURI.toAbsolute(v.params.src)),l=(new n("object",1)).attr({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:C}),tinymce.each(e,function(e){var t=v[e];e=="class"&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&e!="type"&&l.attr(e,t)});for(p in v.params)b=new n("param",1),b.shortEnded=!0,d=v.params[p],p==="src"&&w.name==="WindowsMedia"&&(p="url"),b.attr({name:p,value:d}),l.append(b);if(this.editor.getParam("media_strict",!0))l.attr({data:v.params.src,type:w.mimes[0]});else{l.attr({classid:"clsid:"+w.clsids[0],codebase:w.codebase}),c=new n("embed",1),c.shortEnded=!0,c.attr({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:C,type:w.mimes[0]});for(p in v.params)c.attr(p,v.params[p]);tinymce.each(e,function(e){v[e]&&e!="type"&&c.attr(e,v[e])}),l.append(c)}v.object_html&&(d=new n("#text",3),d.raw=!0,d.value=v.object_html,l.append(d)),f&&f.append(l)}f&&v.video_html&&(d=new n("#text",3),d.raw=!0,d.value=v.video_html,f.append(d)),k&&v.video_html&&(d=new n("#text",3),d.raw=!0,d.value=v.video_html,k.append(d));var A=f||k||l||c;A?t.replace(A):t.remove()},objectToImg:function(r){function P(e){return(new tinymce.html.Serializer({inner:!0,validate:!1})).serialize(e)}function H(e,t){return N[(e.attr(t)||"").toLowerCase()]}function B(e){var t=e.replace(/^.*\.([^.]+)$/,"$1");return N[t.toLowerCase()||""]}var o,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N=this.lookup,C,k,L=this.editor.settings.url_converter,A=this.editor.settings.url_converter_scope,O,M,_,D;if(!r.parent)return;if(r.name==="script"){r.firstChild&&(C=i.exec(r.firstChild.value));if(!C)return;T=C[1],x={video:{},params:s.parse(C[2])},d=x.params.width,v=x.params.height}x=x||{video:{},params:{}},c=new n("img",1),c.attr({src:this.editor.theme.url+"/img/trans.gif"}),h=r.name;if(h==="video"||h=="audio"){f=r,o=r.getAll("object")[0],a=r.getAll("embed")[0],d=f.attr("width"),v=f.attr("height"),p=f.attr("id"),x.video={attrs:{},sources:[]},k=x.video.attrs;for(h in f.attributes.map)k[h]=f.attributes.map[h];E=r.attr("src"),E&&x.video.sources.push({src:L.call(A,E,"src",r.name)}),S=f.getAll("source");for(g=0;g<S.length;g++)E=S[g].remove(),x.video.sources.push({src:L.call(A,E.attr("src"),"src","source"),type:E.attr("type"),media:E.attr("media")});k.poster&&(k.poster=L.call(A,k.poster,"poster",r.name))}r.name==="object"&&(o=r,a=r.getAll("embed")[0]),r.name==="embed"&&(a=r),r.name==="iframe"&&(l=r,T="Iframe");if(o){d=d||o.attr("width"),v=v||o.attr("height"),m=m||o.attr("style"),p=p||o.attr("id"),O=O||o.attr("hspace"),M=M||o.attr("vspace"),_=_||o.attr("align"),D=D||o.attr("bgcolor"),x.name=o.attr("name"),w=o.getAll("param");for(g=0;g<w.length;g++)b=w[g],h=b.remove().attr("name"),t[h]||(x.params[h]=b.attr("value"));x.params.src=x.params.src||o.attr("data")}if(a){d=d||a.attr("width"),v=v||a.attr("height"),m=m||a.attr("style"),p=p||a.attr("id"),O=O||a.attr("hspace"),M=M||a.attr("vspace"),_=_||a.attr("align"),D=D||a.attr("bgcolor");for(h in a.attributes.map)!t[h]&&!x.params[h]&&(x.params[h]=a.attributes.map[h])}if(l){d=u(l.attr("width")),v=u(l.attr("height")),m=m||l.attr("style"),p=l.attr("id"),O=l.attr("hspace"),M=l.attr("vspace"),_=l.attr("align"),D=l.attr("bgcolor"),tinymce.each(e,function(e){c.attr(e,l.attr(e))});for(h in l.attributes.map)!t[h]&&!x.params[h]&&(x.params[h]=l.attributes.map[h])}x.params.movie&&(x.params.src=x.params.src||x.params.movie,delete x.params.movie),x.params.src&&(x.params.src=L.call(A,x.params.src,"src","object")),f&&(r.name==="video"?T=N.video.name:r.name==="audio"&&(T=N.audio.name)),o&&!T&&(T=(H(o,"clsid")||H(o,"classid")||H(o,"type")||{}).name),a&&!T&&(T=(H(a,"type")||B(x.params.src)||{}).name),a&&T=="EmbeddedAudio"&&(x.params.type=a.attr("type")),r.replace(c),a&&a.remove(),o&&(y=P(o.remove()),y&&(x.object_html=y)),f&&(y=P(f.remove()),y&&(x.video_html=y)),x.hspace=O,x.vspace=M,x.align=_,x.bgcolor=D,c.attr({id:p,"class":"mceItemMedia mceItem"+(T||"Flash"),style:m,width:d||(r.name=="audio"?"300":"320"),height:v||(r.name=="audio"?"32":"240"),hspace:O,vspace:M,align:_,bgcolor:D,"data-mce-json":s.serialize(x,"'")})}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();