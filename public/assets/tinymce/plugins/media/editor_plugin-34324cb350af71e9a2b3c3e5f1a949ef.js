(function(){function u(e){return typeof e=="string"?e.replace(/[^0-9%]/g,""):e}function a(e){var t,n,r;if(e&&!e.splice){n=[];for(r=0;!0;r++){if(!e[r])break;n[r]=e[r]}return n}return e}var e=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),t=tinymce.makeMap(e.join(",")),n=tinymce.html.Node,r,i,s=tinymce.util.JSON,o;r=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]],tinymce.create("tinymce.plugins.MediaPlugin",{init:function(t,n){function p(e){return e&&e.nodeName==="IMG"&&t.dom.hasClass(e,"mceItemMedia")}var o=this,u={},a,f,l,c;o.editor=t,o.url=n,i="";for(a=0;a<r.length;a++){c=r[a][0],l={name:c,clsids:tinymce.explode(r[a][1]||""),mimes:tinymce.explode(r[a][2]||""),codebase:r[a][3]};for(f=0;f<l.clsids.length;f++)u["clsid:"+l.clsids[f]]=l;for(f=0;f<l.mimes.length;f++)u[l.mimes[f]]=l;u["mceItem"+c]=l,u[c.toLowerCase()]=l,i+=(i?"|":"")+c}tinymce.each(t.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(e){var t,n,r;e=e.split(/=/),n=tinymce.explode(e[1].toLowerCase());for(t=0;t<n.length;t++)r=u[e[0].toLowerCase()],r&&(u[n[t]]=r)}),i=new RegExp("write("+i+")\\(([^)]+)\\)"),o.lookup=u,t.onPreInit.add(function(){t.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),t.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(e){var t=e.length;while(t--)o.objectToImg(e[t])}),t.serializer.addNodeFilter("img",function(e,t,n){var r=e.length,i;while(r--)i=e[r],(i.attr("class")||"").indexOf("mceItemMedia")!==-1&&o.imgToObject(i,n)})}),t.onInit.add(function(){t.theme&&t.theme.onResolveName&&t.theme.onResolveName.add(function(e,n){n.name==="img"&&t.dom.hasClass(n.node,"mceItemMedia")&&(n.name="media")}),t&&t.plugins.contextmenu&&t.plugins.contextmenu.onContextMenu.add(function(e,t,n){n.nodeName==="IMG"&&n.className.indexOf("mceItemMedia")!==-1&&t.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),t.addCommand("mceMedia",function(){var r,i;i=t.selection.getNode(),p(i)&&(r=t.dom.getAttrib(i,"data-mce-json"),r&&(r=s.parse(r),tinymce.each(e,function(e){var n=t.dom.getAttrib(i,e);n&&(r[e]=n)}),r.type=o.getType(i.className).name.toLowerCase())),r||(r={type:"flash",video:{sources:[]},params:{}}),t.windowManager.open({file:n+"/media.htm",width:430+parseInt(t.getLang("media.delta_width",0)),height:500+parseInt(t.getLang("media.delta_height",0)),inline:1},{plugin_url:n,data:r})}),t.addButton("media",{title:"media.desc",cmd:"mceMedia"}),t.onNodeChange.add(function(e,t,n){t.setActive("media",p(n))})},convertUrl:function(e,t){var n=this,r=n.editor,i=r.settings,s=i.url_converter,o=i.url_converter_scope||n;return e?t?r.documentBaseURI.toAbsolute(e):s.call(o,e,"src","object"):e},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(e,t){var n=this,r=n.editor,i=r.documentBaseURI,o,f,l,p;e.params.src=n.convertUrl(e.params.src,t),f=e.video.attrs,f&&(f.src=n.convertUrl(f.src,t)),f&&(f.poster=n.convertUrl(f.poster,t)),o=a(e.video.sources);if(o)for(p=0;p<o.length;p++)o[p].src=n.convertUrl(o[p].src,t);return l=n.editor.dom.create("img",{id:e.id,style:e.style,align:e.align,hspace:e.hspace,vspace:e.vspace,src:n.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+n.getType(e.type).name,"data-mce-json":s.serialize(e,"'")}),l.width=e.width=u(e.width||(e.type=="audio"?"300":"320")),l.height=e.height=u(e.height||(e.type=="audio"?"32":"240")),l},dataToHtml:function(e,t){return this.editor.serializer.serialize(this.dataToImg(e,t),{forced_root_block:"",force_absolute:t})},htmlToData:function(t){var n,r,i;return i={type:"flash",video:{sources:[]},params:{}},n=this.editor.parser.parse(t),r=n.getAll("img")[0],r&&(i=s.parse(r.attr("data-mce-json")),i.type=this.getType(r.attr("class")).name.toLowerCase(),tinymce.each(e,function(e){var t=r.attr(e);t&&(i[e]=t)})),i},getType:function(e){var t,n,r;n=tinymce.explode(e," ");for(t=0;t<n.length;t++){r=this.lookup[n[t]];if(r)return r}},imgToObject:function(t,r){function _(e,t){var n,r,s,u,a;a=o.getParam("flash_video_player_url",i.convertUrl(i.url+"/moxieplayer.swf")),a&&(n=o.documentBaseURI,y.params.src=a,o.getParam("flash_video_player_absvideourl",!0)&&(e=n.toAbsolute(e||"",!0),t=n.toAbsolute(t||"",!0)),s="",r=o.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(r,function(n,r){n=n.replace(/\$url/,e||""),n=n.replace(/\$poster/,t||""),n.length>0&&(s+=(s?"&":"")+r+"="+escape(n))}),s.length&&(y.params.flashvars=s),u=o.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(u,function(e,t){y.params[t]=""+e}))}var i=this,o=i.editor,l,p,d,v,m,g,y,w,E,S,x,T,N,C,k,L,A,O,M;y=t.attr("data-mce-json");if(!y)return;y=s.parse(y),T=this.getType(t.attr("class")),O=t.attr("data-mce-style"),O||(O=t.attr("style"),O&&(O=o.dom.serializeStyle(o.dom.parseStyle(O,"img")))),y.width=t.attr("width")||y.width,y.height=t.attr("height")||y.height;if(T.name==="Iframe"){L=new n("iframe",1),tinymce.each(e,function(e){var n=t.attr(e);e=="class"&&n&&(n=n.replace(/mceItem.+ ?/g,"")),n&&n.length>0&&L.attr(e,n)});for(m in y.params)L.attr(m,y.params[m]);L.attr({style:O,src:y.params.src}),t.replace(L);return}if(this.editor.settings.media_use_script){L=(new n("script",1)).attr("type","text/javascript"),g=new n("#text",3),g.value="write"+T.name+"("+s.serialize(tinymce.extend(y.params,{width:t.attr("width"),height:t.attr("height")}))+");",L.append(g),t.replace(L);return}if(T.name==="Video"&&y.video.sources[0]){l=(new n("video",1)).attr(tinymce.extend({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:O},y.video.attrs)),y.video.attrs&&(A=y.video.attrs.poster),E=y.video.sources=a(y.video.sources);for(N=0;N<E.length;N++)/\.mp4$/.test(E[N].src)&&(k=E[N].src);E[0].type||(l.attr("src",E[0].src),E.splice(0,1));for(N=0;N<E.length;N++)w=(new n("source",1)).attr(E[N]),w.shortEnded=!0,l.append(w);k?(_(k,A),T=i.getType("flash")):y.params.src=""}if(T.name==="Audio"&&y.video.sources[0]){M=(new n("audio",1)).attr(tinymce.extend({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:O},y.video.attrs)),y.video.attrs&&(A=y.video.attrs.poster),E=y.video.sources=a(y.video.sources),E[0].type||(M.attr("src",E[0].src),E.splice(0,1));for(N=0;N<E.length;N++)w=(new n("source",1)).attr(E[N]),w.shortEnded=!0,M.append(w);y.params.src=""}if(T.name==="EmbeddedAudio"){d=new n("embed",1),d.shortEnded=!0,d.attr({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:O,type:t.attr("type")});for(m in y.params)d.attr(m,y.params[m]);tinymce.each(e,function(e){y[e]&&e!="type"&&d.attr(e,y[e])}),y.params.src=""}if(y.params.src){/\.flv$/i.test(y.params.src)&&_(y.params.src,""),r&&r.force_absolute&&(y.params.src=o.documentBaseURI.toAbsolute(y.params.src)),p=(new n("object",1)).attr({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:O}),tinymce.each(e,function(e){var t=y[e];e=="class"&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&e!="type"&&p.attr(e,t)});for(m in y.params)x=new n("param",1),x.shortEnded=!0,g=y.params[m],m==="src"&&T.name==="WindowsMedia"&&(m="url"),x.attr({name:m,value:g}),p.append(x);if(this.editor.getParam("media_strict",!0))p.attr({data:y.params.src,type:T.mimes[0]});else{p.attr({classid:"clsid:"+T.clsids[0],codebase:T.codebase}),d=new n("embed",1),d.shortEnded=!0,d.attr({id:t.attr("id"),width:u(t.attr("width")),height:u(t.attr("height")),style:O,type:T.mimes[0]});for(m in y.params)d.attr(m,y.params[m]);tinymce.each(e,function(e){y[e]&&e!="type"&&d.attr(e,y[e])}),p.append(d)}y.object_html&&(g=new n("#text",3),g.raw=!0,g.value=y.object_html,p.append(g)),l&&l.append(p)}l&&y.video_html&&(g=new n("#text",3),g.raw=!0,g.value=y.video_html,l.append(g)),M&&y.video_html&&(g=new n("#text",3),g.raw=!0,g.value=y.video_html,M.append(g));var D=l||M||p||d;D?t.replace(D):t.remove()},objectToImg:function(r){function j(e){return(new tinymce.html.Serializer({inner:!0,validate:!1})).serialize(e)}function F(e,t){return L[(e.attr(t)||"").toLowerCase()]}function I(e){var t=e.replace(/^.*\.([^.]+)$/,"$1");return L[t.toLowerCase()||""]}var o,a,l,c,p,d,v,m,g,y,w,E,S,x,T,N,C,k,L=this.lookup,A,O,M=this.editor.settings.url_converter,_=this.editor.settings.url_converter_scope,D,P,H,B;if(!r.parent)return;if(r.name==="script"){r.firstChild&&(A=i.exec(r.firstChild.value));if(!A)return;k=A[1],C={video:{},params:s.parse(A[2])},m=C.params.width,g=C.params.height}C=C||{video:{},params:{}},p=new n("img",1),p.attr({src:this.editor.theme.url+"/img/trans.gif"}),d=r.name;if(d==="video"||d=="audio"){l=r,o=r.getAll("object")[0],a=r.getAll("embed")[0],m=l.attr("width"),g=l.attr("height"),v=l.attr("id"),C.video={attrs:{},sources:[]},O=C.video.attrs;for(d in l.attributes.map)O[d]=l.attributes.map[d];T=r.attr("src"),T&&C.video.sources.push({src:M.call(_,T,"src",r.name)}),N=l.getAll("source");for(w=0;w<N.length;w++)T=N[w].remove(),C.video.sources.push({src:M.call(_,T.attr("src"),"src","source"),type:T.attr("type"),media:T.attr("media")});O.poster&&(O.poster=M.call(_,O.poster,"poster",r.name))}r.name==="object"&&(o=r,a=r.getAll("embed")[0]),r.name==="embed"&&(a=r),r.name==="iframe"&&(c=r,k="Iframe");if(o){m=m||o.attr("width"),g=g||o.attr("height"),y=y||o.attr("style"),v=v||o.attr("id"),D=D||o.attr("hspace"),P=P||o.attr("vspace"),H=H||o.attr("align"),B=B||o.attr("bgcolor"),C.name=o.attr("name"),x=o.getAll("param");for(w=0;w<x.length;w++)S=x[w],d=S.remove().attr("name"),t[d]||(C.params[d]=S.attr("value"));C.params.src=C.params.src||o.attr("data")}if(a){m=m||a.attr("width"),g=g||a.attr("height"),y=y||a.attr("style"),v=v||a.attr("id"),D=D||a.attr("hspace"),P=P||a.attr("vspace"),H=H||a.attr("align"),B=B||a.attr("bgcolor");for(d in a.attributes.map)!t[d]&&!C.params[d]&&(C.params[d]=a.attributes.map[d])}if(c){m=u(c.attr("width")),g=u(c.attr("height")),y=y||c.attr("style"),v=c.attr("id"),D=c.attr("hspace"),P=c.attr("vspace"),H=c.attr("align"),B=c.attr("bgcolor"),tinymce.each(e,function(e){p.attr(e,c.attr(e))});for(d in c.attributes.map)!t[d]&&!C.params[d]&&(C.params[d]=c.attributes.map[d])}C.params.movie&&(C.params.src=C.params.src||C.params.movie,delete C.params.movie),C.params.src&&(C.params.src=M.call(_,C.params.src,"src","object")),l&&(r.name==="video"?k=L.video.name:r.name==="audio"&&(k=L.audio.name)),o&&!k&&(k=(F(o,"clsid")||F(o,"classid")||F(o,"type")||{}).name),a&&!k&&(k=(F(a,"type")||I(C.params.src)||{}).name),a&&k=="EmbeddedAudio"&&(C.params.type=a.attr("type")),r.replace(p),a&&a.remove(),o&&(E=j(o.remove()),E&&(C.object_html=E)),l&&(E=j(l.remove()),E&&(C.video_html=E)),C.hspace=D,C.vspace=P,C.align=H,C.bgcolor=B,p.attr({id:v,"class":"mceItemMedia mceItem"+(k||"Flash"),style:y,width:m||(r.name=="audio"?"300":"320"),height:g||(r.name=="audio"?"32":"240"),hspace:D,vspace:P,align:H,bgcolor:B,"data-mce-json":s.serialize(C,"'")})}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();